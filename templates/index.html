<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hệ Thống Dữ Liệu Gen Mía & Cây Trồng Việt Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      .nav-item {
        @apply text-gray-700 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium cursor-pointer transition-colors duration-200;
      }
      .dropdown-content {
        @apply hidden absolute bg-white shadow-lg mt-2 rounded-md w-64 z-50 border border-gray-100;
      }
      .dropdown:hover .dropdown-content {
        @apply block;
      } /* Hiển thị khi hover */
      .hero-pattern {
        background-image: url("https://images.unsplash.com/photo-1598512752271-33f913a5af13?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80"); /* Ảnh lá cây/mía */
        background-size: cover;
        background-position: center;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <nav class="bg-white shadow-md sticky top-0 z-50 font-sans">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div
            class="flex items-center cursor-pointer"
            onclick="window.location.href='/'"
          >
            <span class="material-icons text-teal-600 text-4xl mr-2">spa</span>
            <div>
              <h1 class="font-bold text-xl tracking-tight text-gray-900">
                BioHub Vietnam
              </h1>
              <p class="text-xs text-gray-500 uppercase tracking-wide">
                Genomic Data Portal
              </p>
            </div>
          </div>

          <div class="hidden md:flex items-center space-x-1">
            <a
              href="/"
              class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-teal-600 hover:bg-gray-50 rounded-md transition"
            >
              Home
            </a>

            <div class="relative group h-full flex items-center">
              <button
                class="px-4 py-2 text-sm font-medium text-gray-700 group-hover:text-teal-600 hover:bg-gray-50 rounded-md inline-flex items-center transition"
              >
                Genomes
                <span class="material-icons text-sm ml-1">expand_more</span>
              </button>
              <div
                class="absolute top-12 left-0 w-72 bg-white border border-gray-200 shadow-xl rounded-md hidden group-hover:block z-50"
              >
                <div class="py-2 max-h-96 overflow-y-auto">
                  <div
                    class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase"
                  >
                    Mới cập nhật
                  </div>
                  {% for species in navbar_genomes %}
                  <a
                    href="/genome/{{ species.name }}"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700 border-b border-gray-100 last:border-0"
                  >
                    {{ species.common_name }}
                  </a>
                  {% endfor %}
                  <a
                    href="#genomes-section"
                    class="block px-4 py-2 text-sm font-bold text-teal-600 text-center bg-gray-50 hover:bg-gray-100"
                  >
                    Xem tất cả bộ gen
                  </a>
                </div>
              </div>
            </div>

            <div class="relative group h-full flex items-center">
              <button
                class="px-4 py-2 text-sm font-medium text-gray-700 group-hover:text-teal-600 hover:bg-gray-50 rounded-md inline-flex items-center transition"
              >
                JBrowse
                <span class="material-icons text-sm ml-1">expand_more</span>
              </button>
              <div
                class="absolute top-12 left-0 w-72 bg-white border border-gray-200 shadow-xl rounded-md hidden group-hover:block z-50"
              >
                <div class="py-2 max-h-96 overflow-y-auto">
                  <div
                    class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase"
                  >
                    Chọn gen để xem
                  </div>
                  {% for species in navbar_genomes %}
                  <a
                    href="/jbrowse_view?chrom={{ species.name }}"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700 border-b border-gray-100 last:border-0"
                  >
                    {{ species.common_name }}
                  </a>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="relative group h-full flex items-center">
              <button
                class="px-4 py-2 text-sm font-medium text-gray-700 group-hover:text-teal-600 hover:bg-gray-50 rounded-md inline-flex items-center transition"
              >
                Search
                <span class="material-icons text-sm ml-1">expand_more</span>
              </button>
              <div
                class="absolute top-12 left-0 w-64 bg-white border border-gray-200 shadow-xl rounded-md hidden group-hover:block z-50"
              >
                <div class="py-2">
                  <a
                    href="/#gene-search-section"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700"
                  >
                    <span class="material-icons text-xs mr-2 align-middle"
                      >search</span
                    >Tra cứu Gen (Metadata)
                  </a>
                  <a
                    href="/blast"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700"
                  >
                    <span class="material-icons text-xs mr-2 align-middle"
                      >saved_search</span
                    >BLAST Search
                  </a>
                  <div class="border-t border-gray-100 my-1"></div>
                  <a
                    href="/primer"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700"
                  >
                    <span class="material-icons text-xs mr-2 align-middle"
                      >linear_scale</span
                    >Primer Designer
                  </a>
                  <a
                    href="/crispr_designer"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700"
                  >
                    <span class="material-icons text-xs mr-2 align-middle"
                      >content_cut</span
                    >CRISPR Designer
                  </a>
                </div>
              </div>
            </div>

            <a
              href="/upload"
              class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-teal-600 hover:bg-gray-50 rounded-md transition flex items-center"
            >
              <span class="material-icons text-sm mr-1">cloud_upload</span>
              Upload
            </a>

            <a
              href="#"
              onclick="alert('Trang Danh sách Nghiên cứu đang được xây dựng!')"
              class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-teal-600 hover:bg-gray-50 rounded-md transition"
            >
              Studies
            </a>

            <a
              href="#"
              class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-teal-600 hover:bg-gray-50 rounded-md transition"
            >
              About
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="hero-pattern relative bg-gray-900 h-96 flex items-center justify-center"
    >
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="relative z-10 text-center px-4">
        <h1
          class="text-4xl md:text-6xl font-extrabold text-white mb-4 tracking-tight"
        >
          Cổng Dữ Liệu Gen & Công Cụ Phân Tích
        </h1>
        <p class="text-xl md:text-2xl text-gray-200 mb-8 max-w-3xl mx-auto">
          Nền tảng tập trung cho dữ liệu genomic, công cụ phân tích và nghiên
          cứu các giống cây trồng chủ lực tại Việt Nam.
        </p>
        <a
          href="#tools-section"
          class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg transform hover:scale-105"
        >
          Khám phá Công cụ
        </a>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div
        id="gene-search-section"
        class="bg-white rounded-xl shadow-lg p-8 mb-16 -mt-20 relative z-20 border-t-4 border-teal-600"
      >
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
          <span class="material-icons text-teal-600 mr-2">search</span> Tra Cứu
          & Chú Giải Gen
        </h2>

        <form id="gene-search-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >1. Chọn Nhóm Loài</label
              >
              <select
                id="species_group"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white shadow-sm"
              ></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >2. Chọn Bộ Gen</label
              >
              <select
                id="species"
                name="species"
                required
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-gray-50 shadow-sm"
              ></select>
            </div>
          </div>

          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >3. Nhập Contig ID / Locus Tag / Mô tả</label
            >
            <input
              type="text"
              id="contig_id"
              name="contig_id"
              required
              placeholder="Ví dụ: JAKOGQ010001029.1 hoặc SuSy-1"
              class="w-full p-4 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 shadow-sm font-mono text-lg"
            />
            <span class="material-icons absolute left-4 top-11 text-gray-400"
              >dna</span
            >
          </div>

          <button
            type="submit"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center text-lg"
          >
            <span id="search-text">Tìm Kiếm Ngay</span>
            <svg
              id="loading-spinner"
              class="animate-spin ml-3 h-5 w-5 text-white hidden"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </button>

          <div
            id="search-status"
            class="p-3 rounded-lg text-center hidden"
          ></div>
        </form>

        <div
          id="search-results"
          class="hidden mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200"
        >
          <h3 class="text-lg font-bold text-gray-900 mb-4">Kết Quả Tìm Kiếm</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-500">Mô tả</p>
              <p id="result-description" class="font-semibold text-gray-800">
                ...
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Contig ID</p>
              <p id="result-contig" class="font-mono font-bold text-teal-700">
                ...
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Độ dài</p>
              <p><span id="result-length" class="font-bold"></span> bp</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Số lượng Features</p>
              <p id="result-features-count" class="font-bold">...</p>
            </div>
          </div>
          <a
            id="gene-view-link"
            href="#"
            class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition shadow"
          >
            Xem Chi Tiết (Gene View)
            <span class="material-icons ml-2 text-sm">arrow_forward</span>
          </a>
        </div>
      </div>

      <section id="tools-section" class="mb-16">
        <div class="text-center mb-10">
          <h2 class="text-3xl font-bold text-gray-900">
            Công Cụ Phân Tích (Available Tools)
          </h2>
          <div class="h-1 w-24 bg-teal-500 mx-auto mt-4 rounded"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          <div
            class="bg-white rounded-xl shadow-md p-6 hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-gray-100"
          >
            <div
              class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto"
            >
              <span class="material-icons text-blue-600 text-3xl"
                >saved_search</span
              >
            </div>
            <h3 class="text-xl font-bold text-center mb-2">BLAST Search</h3>
            <p class="text-gray-600 text-center text-sm mb-4">
              Đối chiếu trình tự gene với cơ sở dữ liệu (Local BLASTN).
            </p>
            <a
              href="/blast"
              class="block text-center text-blue-600 font-semibold hover:underline"
              >Sử dụng ngay →</a
            >
          </div>

          <div
            class="bg-white rounded-xl shadow-md p-6 hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-gray-100"
          >
            <div
              class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto"
            >
              <span class="material-icons text-purple-600 text-3xl"
                >linear_scale</span
              >
            </div>
            <h3 class="text-xl font-bold text-center mb-2">Primer Designer</h3>
            <p class="text-gray-600 text-center text-sm mb-4">
              Thiết kế mồi PCR tự động với tính toán Tm và GC%.
            </p>
            <a
              href="/primer"
              class="block text-center text-purple-600 font-semibold hover:underline"
              >Sử dụng ngay →</a
            >
          </div>

          <div
            class="bg-white rounded-xl shadow-md p-6 hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-gray-100"
          >
            <div
              class="bg-teal-100 w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto"
            >
              <span class="material-icons text-teal-600 text-3xl"
                >content_cut</span
              >
            </div>
            <h3 class="text-xl font-bold text-center mb-2">CRISPR Designer</h3>
            <p class="text-gray-600 text-center text-sm mb-4">
              Thiết kế gRNA chỉnh sửa gen tích hợp AI (Gemini).
            </p>
            <a
              href="/crispr_designer"
              class="block text-center text-teal-600 font-semibold hover:underline"
              >Sử dụng ngay →</a
            >
          </div>

          <div
            class="bg-white rounded-xl shadow-md p-6 hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-gray-100"
          >
            <div
              class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto"
            >
              <span class="material-icons text-orange-600 text-3xl"
                >cloud_upload</span
              >
            </div>
            <h3 class="text-xl font-bold text-center mb-2">Upload Data</h3>
            <p class="text-gray-600 text-center text-sm mb-4">
              Tải lên dữ liệu FASTA/GBFF mới cho hệ thống.
            </p>
            <a
              href="/upload"
              class="block text-center text-orange-600 font-semibold hover:underline"
              >Tải lên →</a
            >
          </div>
        </div>
      </section>

      <section id="genomes-section">
        <div class="text-center mb-10">
          <h2 class="text-3xl font-bold text-gray-900">
            Dữ Liệu Gen Mới Nhất (Latest Genomes)
          </h2>
          <div class="h-1 w-24 bg-teal-500 mx-auto mt-4 rounded"></div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {% for species in navbar_genomes[:8] %}
          <div
            class="bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 hover:shadow-lg transition"
          >
            <div class="h-32 bg-gray-200 relative">
              <img
                src="https://source.unsplash.com/random/400x200/?plant,nature,leaf&sig={{ loop.index }}"
                class="w-full h-full object-cover opacity-80"
                alt="Genome Image"
              />
              <div
                class="absolute top-2 right-2 bg-teal-600 text-white text-xs px-2 py-1 rounded"
              >
                {{ species.group_name }}
              </div>
            </div>
            <div class="p-4">
              <h3
                class="font-bold text-lg text-gray-900 mb-1 truncate"
                title="{{ species.common_name }}"
              >
                {{ species.common_name }}
              </h3>
              <p class="text-xs text-gray-500 font-mono mb-3">
                {{ species.name }}
              </p>
              <div class="flex space-x-2">
                <a
                  href="/gene_view?species={{ species.name }}&contig_id=example"
                  onclick="alert('Vui lòng tìm kiếm contig cụ thể cho loài này')"
                  class="flex-1 text-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded"
                >
                  Info
                </a>
                <a
                  href="/jbrowse_view?chrom={{ species.name }}"
                  class="flex-1 text-center text-xs bg-teal-50 hover:bg-teal-100 text-teal-700 py-2 rounded font-semibold"
                >
                  JBrowse
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="text-center mt-10">
          <button
            class="px-8 py-3 border border-teal-600 text-teal-600 font-bold rounded hover:bg-teal-600 hover:text-white transition duration-300"
          >
            Xem tất cả bộ gen
          </button>
        </div>
      </section>
    </div>

    <footer class="bg-gray-900 text-white py-12 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <h2 class="text-2xl font-bold mb-4">BioHub Vietnam</h2>
        <p class="text-gray-400 mb-8">
          Hệ thống hỗ trợ nghiên cứu sinh học phân tử và tin sinh học.
        </p>
        <div class="text-sm text-gray-500">
          &copy; 2024 BioHub Vietnam Project. Developed by Kien.
        </div>
      </div>
    </footer>

    <script>
      // --- 1. DROPDOWN LOGIC CHO NAVBAR (MOBILE & DESKTOP) ---
      // (Tailwind hover class handles desktop, this is strictly not needed unless for mobile toggle but keeping simple)

      // --- 2. LOGIC TÌM KIẾM (GIỮ NGUYÊN NHƯ CŨ, CHỈ TÍCH HỢP VÀO GIAO DIỆN MỚI) ---

      // Nhận dữ liệu genome_groups từ Flask (biến này phải được truyền ở home route)
      const genomeGroups = {{ genome_groups | tojson }};
      const groupSelect = document.getElementById('species_group');
      const speciesSelect = document.getElementById('species');

      // Khởi tạo Dropdown
      function initGroupDropdown() {
          groupSelect.innerHTML = '';
          for (const groupName in genomeGroups) {
              const option = document.createElement('option');
              option.value = groupName;
              const count = genomeGroups[groupName].length;
              option.textContent = `${groupName} (${count})`;
              groupSelect.appendChild(option);
          }
          updateSpeciesDropdown();
      }

      function updateSpeciesDropdown() {
          speciesSelect.innerHTML = '';
          const selectedGroup = groupSelect.value;
          const genomes = genomeGroups[selectedGroup];
          if (genomes) {
              genomes.forEach(genome => {
                  const option = document.createElement('option');
                  option.value = genome.id;
                  option.textContent = genome.name;
                  speciesSelect.appendChild(option);
              });
              speciesSelect.disabled = false;
          } else {
              speciesSelect.disabled = true;
          }
      }

      if (groupSelect) {
          groupSelect.addEventListener('change', updateSpeciesDropdown);
          document.addEventListener('DOMContentLoaded', initGroupDropdown);
      }

      // --- XỬ LÝ SUBMIT FORM TÌM KIẾM (LOGIC CŨ) ---
      document.getElementById("gene-search-form").addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const species = form.species.value;
          let contigId = form.contig_id.value.trim();
          if (contigId.startsWith(">")) contigId = contigId.substring(1).trim();

          const statusDiv = document.getElementById("search-status");
          const resultsDiv = document.getElementById("search-results");
          const submitButton = form.querySelector('button[type="submit"]');
          const loadingSpinner = document.getElementById("loading-spinner");
          const searchText = document.getElementById("search-text");

          // Loading UI
          statusDiv.classList.add("hidden");
          resultsDiv.classList.add("hidden");
          searchText.textContent = "Đang xử lý...";
          loadingSpinner.classList.remove("hidden");
          submitButton.disabled = true;

          try {
              const url = `/api/gene_search?species=${encodeURIComponent(species)}&contig_id=${encodeURIComponent(contigId)}`;
              const response = await fetch(url);
              const data = await response.json();

              if (!response.ok) throw new Error(data.error || "Lỗi tìm kiếm.");

              // Success UI
              document.getElementById("result-description").textContent = data.description;
              document.getElementById("result-contig").textContent = data.contig_id;
              document.getElementById("result-length").textContent = data.sequence_length.toLocaleString();
              document.getElementById("result-features-count").textContent = data.features ? data.features.length.toLocaleString() : "0";

              const params = new URLSearchParams({ species: species, contig_id: data.contig_id }).toString();
              document.getElementById("gene-view-link").href = `/gene_view?${params}`;

              resultsDiv.classList.remove("hidden");
              // Scroll to results
              resultsDiv.scrollIntoView({ behavior: 'smooth' });

          } catch (error) {
              statusDiv.classList.remove("hidden");
              statusDiv.innerHTML = `<span class="text-red-600 font-bold">⚠️ Lỗi: ${error.message}</span>`;
              statusDiv.className = "mt-4 p-4 bg-red-50 rounded-lg text-center border border-red-200";
          } finally {
              searchText.textContent = "Tìm Kiếm Ngay";
              loadingSpinner.classList.add("hidden");
              submitButton.disabled = false;
          }
      });
    </script>
  </body>
</html>
